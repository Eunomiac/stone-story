// = CONFIG =
// - MOBILE-SPECIFIC SETTINGS
var isSpeedRunning = false
var preferMelee = false
var isPickPocketingWithSkeletonArm = true
var isOnPPKillQuest = false

// - THRESHOLD VALUES
var smiteThreshold = 6
var dmgDebuffThreshold = 7
var splashThreshold = 3
var foeArmorThreshold = 50
var fastArmorShieldMax = 14
var maxPickPocketBuffs = 1 // *** NEW ***
var maxOverAvgToExitMult = 0 // *** NEW ***
var devourFireRuneThreshold = 3
var devourFireRuneBossThreshold = 10
                                
// - ARSENAL
var splashMeleeWeapon = "big aether sword U"
var healthHammer = "vigor hammer"
var antiArmorMeleeWeapon = "heavy hammer"
var debuffDamageWeapon = "poison sword dP"
var debuffDoTWeapon = "fire sword dF"
var debuffChillWeapon = "ice sword dI"                                         
var magicRangedWeapon = "vigor staff"
var lifeStealMeleeWeapon = false
var lifeStealRangedWeapon = false
var lifeStealShield = "vigor shield h"
var icePillarWeapon = "big aether sword U"
var fastArmorShield = "compound shield +10"
var strongArmorShield = "compound shield +11"
var iceWandA = "ice wand +15"
var iceWandB = "ice wand +12"
var iceWandBossA = iceWandA
var iceWandBossB = iceWandB
var stoneHammerA = "stone hammer +10"
var stoneHammerB = "stone hammer +6"

// - DEFAULT EQUIPMENT
var mainWeapon = "big aether sword U"
var mainShield = strongArmorShield
var mainRanged = "repeating crossbow"

// - ELEMENTAL WEAPONS
var elemWeapons = [
^mainWeapon,
^"poison sword D",
^"vigor sword D",
^"aether sword D",
^"fire sword D",
^"ice sword +11 D"
]

var elemOffHand = [
^false,
^false,
^false,
^false,
^false,
^"ice sword +10 D"
] 

var elemRanged = [
^mainRanged,
^"poison crossbow D",
^"vigor staff D",
^"aether crossbow D",
^"fire crossbow D",
^"ice crossbow D"
]

var elemShields = [
^mainShield,
^mainShield,
^mainShield,
^mainShield,
^mainShield,
^mainShield
]

// - POTIONS
var locPotions = [
^"lucky",
^"lucky",
^"lucky",
^"lucky",
^"lucky",
^"lucky",
^"lucky",
^"lucky" 
]            

// ---- BOSSES ----
var poisonDebuffThreshold = [                          
^0,
^1,
^1,
^0.25,
^1,
^1,
^0.15,
^0.15
]

var iceDebuffThreshold = [
^0.1,
^1,
^1,
^0.1,
^0.1,
^1,
^1,
^1
]

var fireDebuffThreshold = [                       
^0.05,
^1,
^1,
^0.1,
^0.05,
^1,
^0.15,
^0.05
]

var maskDebuffThreshold = [
^0.15,
^1,
^0.15,
^0.15,
^0.15,
^1,
^0.15,
^1
]
// = END CONFIG =

var bosses = ["dysangelos", "poena", "bolesh", "morel", "pallas", "bronze_guardian", "yeti", "nagaraja"]
var bossNoDebuffCheck = [false, false, false, false, "phase2", false, false, false]
var locations = ["Rocky Plateau", "Deadwood Canyon", "Caves of Fear", "Mushroom Forest", "Haunted Halls",  "Boiling Mine", "Icy Ridge", "Temple"]
var locElems = ["none",  "none", "poison", "vigor", "aether", "fire", "ice", "poison"]
var elements = ["none", "vigor", "aether", "fire", "ice", "poison"]
var counterElements = ["none", "poison", "vigor",  "aether", "fire", "ice"]
var potions = ["experience","strength","healing","lightning","invisibility","cleansing","berserk","defensive","lucky","vampiric"]
var ingredients = ["wood + wood", "stone + stone", "tar + tar", "bronze + bronze", "wood + stone", "wood + tar", "wood + bronze", "stone + tar", "stone + bronze", "tar + bronze"]
var healingPotions = ["defensive", "vampiric", "cleansing", "healing"]
var offensivePotions = ["strength", "lightning", "berserk", "lucky"]
var defensivePotions = ["invisibility", "cleansing", "defensive"]
var utilityPotions = ["experience"]
var ranges = ["melee", "close", "medium", "ranged", "screen"]
var units = [5, 11, 16, 25, 35]

func isHealingPotion(item)
  for i = 0..(healingPotions.Count() - 1)
    ?item = healingPotions[i]
      return true
  return false

func isOffensivePotion(item)
  for i = 0..(offensivePotions.Count() - 1)
    ?item = offensivePotions[i]
      return true
  return false

func isDefensivePotion(item)
  for i = 0..(defensivePotions.Count() - 1)
    ?item = defensivePotions[i]
      return true
  return false

func Set(key, val)
    storage.Set(key, val)
  return val

func Get(key)
    return storage.Get(key)

func Toggle(key)
  Set(key, !Get(key))
  return Get(key)
  
func Cycle(key, vals)
  var curVal = Get(key)
  var index = vals.IndexOf(curVal)
  ?index = vals.Count()
    Set(key, vals[0])
  :
    Set(key, vals[index])
    
func Has(key)
  return storage.Has(key)
  
func Incr(key)
    storage.Incr(key)
  
func AddTo(key, num)
    storage.Incr(key, num)
 
func Init()
  ?!Has("assignedLeft")
    Set("assignedLeft", false)
    Set("leftPriority", 0)
  ?!Has("assignedBoth")
    Set("assignedBoth", false)
    Set("bothPriority", 0)
  ?!Has("assignedRight")
    Set("assignedRight", false)
    Set("rightPriority", 0)
  ?!Has("isActivating")
    Set("isActivating", false)
  ?!Has("mindFreeze")
    Set("mindFreeze", 0)

func Reset(isLocStart)
  InitLeft()
  InitRight()
  InitBoth()
  Set("isActivating", false)

  ?isLocStart
    Set("assignedLeft", false)
    Set("leftPriority", 0)
    Set("assignedRight", false)
    Set("rightPriority", 0)
    Set("assignedBoth", false)
    Set("bothPriority", 0)
    Set("mindFreeze", 0)

func ActivateItem()
  ?Get("isActivating")
  ^ & [Get("assignedLeft"), Get("assignedRight"), Get("assignedBoth")].Contains(Get("isActivating"))
  ^ & item.CanActivate()
    activate R
  
func InitLeft()
  var stateWatch = 0
  ?Get("leftPriority") >= 10
    stateWatch = Get("leftPriority") / 10
    ?item.left & Type(item.left.state) = int & item.left.state = stateWatch
      return    
    :
      Set("leftPriority", 0)
    
  ?Get("leftPriority") < 4
    Set("assignedLeft", false)
    Set("leftPriority", 0)

func InitRight()
  var stateWatch = 0
  ?Get("rightPriority") >= 10
    stateWatch = Get("rightPriority") / 10
    ?item.right & Type(item.right.state) = int & item.right.state = stateWatch
      return
    :
      Set("rightPriority", 0)
  ?Get("rightPriority") < 4
    Set("assignedRight", false)
    Set("rightPriority", 0)
    
func InitBoth()
  var stateWatch = 0
  ?Get("bothPriority") >= 10
    stateWatch = Get("bothPriority") / 10
    ?item.left & Type(item.left.state) = int & item.left.state = stateWatch
      return    
    :
      Set("bothPriority", 0)
  ?Get("bothPriority") < 4
    Set("assignedBoth", false)
    Set("bothPriority", 0)

func AssignBoth(item, priority)
  ?priority < 0
    Set("bothPriority", 0)
    return
  ?Type(item) = "string" & string.Size(item) > 2
    ?item.GetCount(item) = 0
      return
  ?Get("bothPriority") <= priority & Get("leftPriority") <= priority & Get("rightPriority") <= priority
    Set("assignedBoth", item)
    Set("bothPriority", priority)

func AssignLeft(item, priority)
  ?priority < 0
    Set("leftPriority", 0)
    return
  ?Type(item) = "string" & string.Size(item) > 2
    ?item.GetCount(item) = 0
      return
  ?isTwoHanded(item)
    AssignBoth(item, priority)
  :?Get("leftPriority") <= priority & Get("bothPriority") <= priority
    Set("assignedLeft", item)
    ?item = mind
      Set("mindFreeze", time)
    Set("leftPriority", priority)

func AssignRight(item, priority)
  ?priority < 0
    Set("rightPriority", 0)
    return
  ?Type(item) = "string" & string.Size(item) > 2
    ?item.GetCount(item) = 0
      return
  ?Get("rightPriority") <= priority & Get("bothPriority") <= priority
    Set("assignedRight", item)
    Set("rightPriority", priority)
	
func isValidActivation(param)
  return param & [Get("assignedLeft"), Get("assignedRight"), Get("assignedBoth")].Contains(param)

func AssignActivate(param)
  ?isValidActivation(param)
    Set("isActivating", param)
  
func EquipItems()
  ?Get("assignedLeft") ! false & item.GetCount(Get("assignedLeft")) > 0
    equipL @Get("assignedLeft")@
  ?Get("assignedRight") ! false & item.GetCount(Get("assignedRight")) > 0
    equipR @Get("assignedRight")@
  ?Get("assignedBoth") ! false & item.GetCount(Get("assignedBoth")) > 0
    equip @Get("assignedBoth")@
 
func breakBuff(buff)
  var buffParts = string.Split(buff, ":")
  buffParts[2] = int.Parse(buffParts[2])
  buffParts[3] = int.Parse(buffParts[3])
  return [buffParts[1], buffParts[2], buffParts[3]]
  
func getBuffParts(buffName, buffString)
  var buffStrings = string.split(buffString, ",")
  for buffStr : buffStrings
    var buffParts = string.Split(buffStr, ":")
    ?Type(buffParts) = Type([]) & buffParts.Count() = 4
      ?string.IndexOf(buffParts[1], buffName) > -1
        return [int.Parse(buffParts[2]), int.Parse(buffParts[3])]
  return [0, 0]

func xLookup(val, arr1, arr2)
  ?Type(arr1) ! Type([])
    Set("errorMessage", "'" + arr1 + "' is not an array")
    return false
  ?Type(arr2) ! Type([])
    Set("errorMessage", "'" + arr2 + "' is not an array")
    return false
  var index = arr1.IndexOf(val)
  ?index > -1
    return arr2[index]
  :
    return false

func getBuffCount(buffName)
  return getBuffParts(buffName, buffs.string)[0]

func getDebuffCount(buffName)
  return getBuffParts(buffName, debuffs.string)[0]
  
func getFoeDebuffCount(buffName)
  return getBuffParts(buffName, foe.debuffs.string)[0]

func getArmor()
  return math.Round((armor * 10) + armor.f) / 10

func isCloseAs(range)
  return foe.distance <= xLookup(range, ranges, units)

func isFarAs(range)
  return foe.distance >= xLookup(range, ranges, units)

func isWithin(rangeA, rangeB)
  var unitA = xLookup(rangeA, ranges, units)
  var unitB = xLookup(rangeB, ranges, units)
  return isInRange(unitA, unitB)

func isInRange(min, max)
  ?foe.count > 0
    ?max > min
      return foe.distance >= min & foe.distance <= max
    :
      return foe.distance >= min

func isInState(stateNum, stateTime)
  return foe.state = stateNum & foe.time >= stateTime

func Dodge()
  AssignBoth("mind", 3.5)
  equip mind

func getEndurance()
  var percentFloat = 0.01
  percentFloat = (1.0 * hp) / (1.0 * maxhp)
  return percentFloat

func getDashShield()
  ?item.GetCount("bash") > 0 & item.GetCooldown("bash") <= 0 & (foe.count > 5 | (foe ! immune_to_stun & (foe = boss | foe.damage > 4)))
    return "bash"
  :?item.GetCount("dash") > 0
    return "dash"
  :
    return false

func canDash()
  ?!getDashShield()
    return false
  ?Get("isDashBlocked")
    return false
  ?foe.count >= 10 | getEndurance() < 1 | armor < (0.5 * maxarmor)
    return false

  ?Get("mindFreeze") = 0 | (time - Get("mindFreeze")) > 30
    Set("mindFreeze", 0)
  :
    return false

  ?isInRange(9, 14) & foe ! explode
    return getDashShield()
  return false
  
func isDebuffing(threshold, debuff)
  ?buffs.string = berserk | buffs.string = lucky | buffs.string = strength
    return false
  ?foe.buffs.string = protection
    return false
  ?!isCloseAs("close")
    return false

  for i = 0..(bossNoDebuffCheck.Count() - 1)
    ?foe = bosses[i] & foe = bossNoDebuffCheck[i]
      return false

  var isBelowThreshold = (foe.hp + foe.armor) <= threshold * (foe.maxhp + foe.maxarmor)

  ?debuff = "damage" & threshold ! 1 & hp < (0.25 * maxhp)
    isBelowThreshold = false

  ?isBelowThreshold
    return false

  ?debuff = "damage"
    return foe.debuffs.string ! damage & foe ! immune_to_debuff_damage
  :?debuff = "dot"
    return foe.debuffs.string ! dot
  :?debuff = "chill"
    return getFoeDebuffCount("chill") < 6 & foe ! immune_to_debuff_chill
  :?debuff = "armor"
    return foe.maxarmor > 50 & foe.debuffs.string ! fatigue & item.GetCooldown("hammer") <= 0 & item.CanActivate()
  :?debuff = "feeble"
    return foe.debuffs.string ! feeble & item.GetCooldown("mask") <= 0 & item.CanActivate()

func playerPosIsAtLeast(x)
  var screenPos = screen.FromWorldX(pos.x)
  return screenPos >= x

func playerPosIsAtMost(x)
  var screenPos = screen.FromWorldX(pos.x)
  return screenPos <= x

func toSeconds(frameCount)
  return math.Round(frameCount / 30)
  
func toTime(frameCount)
  var numSeconds = toSeconds(frameCount)
  var numMinutes = math.floor(numSeconds / 60)
  numSeconds -= numMinutes * 60
  var numHours = math.floor(numMinutes / 60)
  numMinutes -= numHours * 60
  ?numHours = 0
    numHours = ""
    ?numMinutes = 0
      numMinutes = ""
  numSeconds = numSeconds + ""
  numMinutes = numMinutes + ""
  numHours = numHours + ""
  ?string.Size(numSeconds) = 1
    numSeconds = "0" + numSeconds
  ?(string.Size(numMinutes) + string.Size(numHours)) > 0
    ?string.Size(numMinutes) = 0
      numMinutes = "00:"
    :?string.Size(numMinutes) = 1
      numMinutes = numMinutes + ":"
    ?string.Size(numHours) > 0
      ?string.Size(numMinutes) = 2
        numMinutes = "0" + numMinutes
      numHours = numHours + ":"
  return numHours + numMinutes + numSeconds
  
func toPercent(num, max)
  var percent = (100 * num) / max
  return percent + "%"

func toSimpleFloat(num)
  return math.Round(num * 100) * 0.01

func getFraction(num, denom)
  return (1.0 * num) / denom

func isAtLeastSecsLeft(secs)
  var secsLeft = (loc.averageTime - totalTime) / 30
  return secsLeft > secs
  
func isLessThanSecsLeft(secs)
  var secsLeft = (loc.averageTime - totalTime) / 30
  return secs > secsLeft

func isOverAvgTime()
  ?maxOverAvgToExitMult = 0
    return false
  ?loc.averageTime
    return getFraction(totalTime, loc.averageTime) > (totalTime * maxOverAvgToExitMult)
  return false

func getCounterElement()
  var element = ""
  var counterElement = ""
  var resString = ""
  var elementString = ""
  ?foe.count > 0
    for i = 1..5
      element = elements[i]
      counterElement = counterElements[i]
      resString = string.Join("", ["adaptive_defense_", counterElement])
      elementString = " " + element + " "
      ?foe = elementString & foe.buffs.string ! resString
        return counterElement
  return false

func getHealingPotion()
  ?res.stone > 1500
    return "defensive"
  :?res.bronze > 1500
    return "vampiric"
  :?res.wood > 1500
    return "cleansing"
  :?res.tar > 3000
    return "healing"
  :?res.stone > res.wood & res.stone > res.bronze
    return "defensive"
  :?res.wood > res.stone & res.wood > res.bronze
    return "cleansing"
  :?res.bronze > res.stone & res.bronze > res.wood
    return "vampiric"
    
func brewPotion(potion)
  ?item.potion = potion
    return
  var ingred = xLookup(potion, potions, ingredients)
  ?ingred = "wood + wood"
    brew wood + wood
  :?ingred = "stone + stone"
    brew stone + stone
  :?ingred = "tar + tar"
    brew tar + tar
  :?ingred = "bronze + bronze"
    brew bronze + bronze
  :?ingred = "wood + stone"
    brew wood + stone
  :?ingred = "wood + tar"
    brew wood + tar
  :?ingred = "wood + bronze"
    brew wood + bronze
  :?ingred = "stone + tar"
    brew stone + tar
  :?ingred = "stone + bronze"
    brew stone + bronze
  :?ingred = "tar + bronze"
    brew tar + bronze

func isFacingBoss()
  ?isInRange(0, 35)
    ?foe = dysangelos | (loc = deadwood & foe = boss) | foe = bolesh | (loc = mushroom & foe = boss) | foe = pallas | foe = bronze_guardian | foe = hrÃ­mnir | foe = nagaraja
      return true
  return false
 
func checkForAAC()
  ?item.left.state = 3
    equipL wand *0
  ?item.right.state = 3
    equipR shield *0

func isRangedWeapon(itemid)
  return itemid = runestone | itemid = crossbow | itemid = wand | itemid = talisman | itemid = staff | itemid = ouroboros
func isTwoHanded(itemid)
  return itemid = crossbow | itemid = heavy hammer | itemid = staff | itemid = bardiche | itemid = blade of the fallen god | itemid = skeleton arm

func isShortOfBestTimeBy(secs)
  return (loc.bestTime - totalTime) / 30 > secs

func getMainWeapon()
  ?splashMeleeWeapon & foe.count > splashThreshold & isCloseAs("melee")
    return splashMeleeWeapon    
  ?antiArmorMeleeWeapon & foe.armor > foeArmorThreshold & isCloseAs("melee")
    return antiArmorMeleeWeapon
  ?getCounterElement()
    return elemWeapons[counterElements.IndexOf(getCounterElement())]
  ?foe = boss
    return debuffChillWeapon
  return mainWeapon

func getMainOffhandWeapon()
  ?foe.state > 0 & getCounterElement() & elemOffHand[counterElements.IndexOf(getCounterElement())]
    return elemOffHand[counterElements.IndexOf(getCounterElement())]
  return false

func getMainShield()
  ?fastArmorShield & armor < fastArmorShieldMax
    return fastArmorShield
  ?getCounterElement()
    return elemShields[counterElements.IndexOf(getCounterElement())]
  return mainShield
  
func getMainRanged()
  ?preferMelee & foe ! explode & foe ! bolesh & foe ! bronze_guardian & foe ! yeti
    return getMainWeapon()
  ?getCounterElement() & (foe.hp + foe.armor) > 200
    return elemRanged[counterElements.IndexOf(getCounterElement())]
  return mainRanged

Init()
Reset(false)

var locPotion = xLookup(loc.name, locations, locPotions)

var debuffDmgThreshold = xLookup(loc.name, locations, poisonDebuffThreshold)
var debuffChillThreshold = xLookup(loc.name, locations, iceDebuffThreshold)
var debuffDotThreshold = xLookup(loc.name, locations, fireDebuffThreshold)
var debuffFeebleThreshold = xLookup(loc.name, locations, maskDebuffThreshold)

var dmgDebuff = 0
dmgDebuff = getDebuffCount("debuff_duration_damage") + getDebuffCount("spider_debuff_damage")

?loc.begin | loc.loop
  Reset(true)
  ?loc.begin & item.potion ! locPotion
    brewPotion(locPotion)

checkForAAC()
AssignRight(getMainShield(), 1)
AssignLeft(getMainWeapon(), 1)
?maxOverAvgToExitMult > 0 & isOverAvgTime()
  loc.Leave()

?getEndurance() < 1
  ?foe.count = 0 | (foe ! spawner & isFarAs("ranged"))
    AssignLeft("ouroboros", 1)
  :?lifeStealMeleeWeapon & foe.damage <= 3 & foe ! boss
    AssignLeft(lifeStealMeleeWeapon, 1)

?pickup.distance < 13
  AssignLeft("star", 2)



Set("isDashBlocked", false)
?foe ! immune_to_ranged & isCloseAs("ranged")

  ?foe = explode
    ?iceWandA & iceWandB & getBuffCount("smite") > 0
    ^& foe ! immune_to_debuff_chill
    ^& getFoeDebuffCount("chill") < 6
      AssignLeft(iceWandA, 3.5)
      AssignRight(iceWandB, 3.5)
      Set("isDashBlocked", true)
    :
      AssignLeft(getMainRanged(), 3.5)
      
  :?isFacingBoss()
    ?item.CanActivate() & (foe ! bronze_guardian | foe.state > 1)
      ?iceWandBossA & iceWandBossB & getBuffCount("smite") > 0
      ^& foe ! immune_to_debuff_chill
      ^& getFoeDebuffCount("chill") < 6
        AssignLeft(iceWandBossA, 2.5)
        AssignRight(iceWandBossB, 2.5)
      :?isWithin("close", "ranged")
        AssignLeft(getMainRanged(), 2.5)
      
  :?foe = magic_vulnerability
   ^| foe = immune_to_physical
   ^| (
   ^    isFarAs("close")
   ^    & foe ! wall & foe ! pillar
   ^  )
    var weapon
    var priority
    weapon = getMainRanged()
    priority = 2.5
    ?foe = magic_vulnerability
      Set("isDashBlocked", true)
      weapon = magicRangedWeapon
      priority = 3
    :?foe = immune_to_physical
      weapon = magicRangedWeapon
      priority = 3      

    ?iceWandA & iceWandB & getBuffCount("smite") > 0
    ^&(foe.count > 5
    ^  | (foe ! spawner
    ^    & getFoeDebuffCount("chill") < 6
    ^    & foe ! immune_to_debuff_chill ) )
      AssignLeft(iceWandA, priority, "Ranged Check (Icy)")
      AssignRight(iceWandB, priority, "Ranged Check (Icy)")
    :?dmgDebuff <= dmgDebuffThreshold
     ^& debuffs.string ! yeti_chill
      AssignLeft(weapon, priority - 0.5, "Ranged Check")

?harvest.distance < 9
  ?harvest = Boulder
    AssignBoth("shovel", 2)
  :
    ?item.GetCooldown("hatchet") <= 0 & harvest.distance <= 4
      AssignRight("hatchet", 2)
      AssignActivate("hatchet")
    :
      AssignRight("hatchet", 2)
?:!Get("isDashBlocked")
^ & item.GetCooldown("quarterstaff") <= 0 & item.CanActivate()
^ & (foe ! bronze_guardian | isInState(33, 10))
^ & (foe ! explode | foe ! bomb cart)
  AssignBoth("quarterstaff", 20)
  AssignActivate("quarterstaff")

?foe ! immune_to_physical
^& (foe.armor + foe.hp) > 300
^& isCloseAs("melee")
^& item.GetCooldown("bardiche") <= 0 & item.CanActivate()
  AssignBoth("bardiche", 20)
  AssignActivate("bardiche")

?item.GetCooldown("blade") <= 0 & item.canActivate()
  ?isCloseAs("ranged")
  ^& foe.count > smiteThreshold
  ^& foe ! spawner
  ^& (isAtLeastSecsLeft(120) | isLessThanSecsLeft(90))
    AssignBoth("blade of the fallen god", 3)
    AssignActivate("blade of the fallen god")

?summon.count = 0
^& item.GetCooldown("fire_talisman") <= 0 & item.CanActivate()
^& isFarAs("medium")
^& foe ! poena
  AssignRight("talis", 20)
  AssignActivate("talis")

?isFacingBoss()

  ?buffs.string ! berserk & buffs.string ! lucky & buffs.string ! strength
    ?item.potion = cleansing
    ^& debuffs.count > 15
      activate potion
    ?healthHammer
    ^& item.potion = defensive
    ^& getEndurance() < 0.66
      ?item.left ! healthHammer
        AssignLeft(healthHammer, 4)
      :?maxhp > 50
        activate potion
        AssignLeft("", -1, "")
    :?getEndurance() < 0.5
    ^& (
    ^  item.potion = healing
    ^| item.potion = defensive
    ^| item.potion = cleansing
    ^| item.potion = vampiric
    ^  )
      activate potion
    
  ?devourFireRuneBossThreshold > 0
  ^& summon.GetId() = cinderwisp
  ^& summon.GetVar("ignition") >= devourFireRuneBossThreshold  
    activate cinderwisp

  ?foe.armor > 0 & item.GetCount("heavy hammer") > 0 & isCloseAs("melee")
    ?item.GetCooldown("hammer") <= 0 & item.CanActivate()
      AssignBoth("heavy hammer", 20)
      AssignActivate("heavy hammer")
    :
      AssignBoth("heavy hammer", 2)

  ?foe = immune_to_physical
    ?iceWandBossA & iceWandBossB
    ^& getBuffCount("smite") > 0
      AssignLeft(iceWandBossA, 3)
      AssignRight(iceWandBossB, 3)
    :
      AssignLeft(magicRangedWeapon, 3)

  ?debuffDamageWeapon & item.GetCount(debuffDamageWeapon) > 0 & isDebuffing(debuffDmgThreshold, "damage")
    AssignRight("cultist mask", 3)
    AssignLeft(debuffDamageWeapon, 3)
  :?debuffDoTWeapon & item.GetCount(debuffDoTWeapon) & isDebuffing(debuffDotThreshold, "dot")
    AssignRight("cultist mask", 3)
    AssignLeft(debuffDoTWeapon, 3)
  :?debuffChillWeapon & item.GetCount(debuffChillWeapon) & isDebuffing(debuffChillThreshold, "chill")
    AssignRight("cultist mask", 3)
    AssignLeft(debuffChillWeapon, 3, "@-Chill-" + getFoeDebuffCount("chill") + "-@")
  :?item.GetCount("heavy hammer") > 0 & isDebuffing(1, "armor")
    AssignBoth("heavy hammer", 20)
    AssignActivate("heavy hammer")
  :?item.GetCount("mask") > 0 & isDebuffing(debuffFeebleThreshold, "feeble")
    AssignRight("cultist mask", 20)
    AssignActivate("cultist mask")

  ?isOffensivePotion(item.potion)
    ?foe = bronze_guardian
      ?isInState(33, 30)
        activate potion
    :?foe = nagaraja
      ?isCloseAs("melee")
        activate potion
    :?foe = bolesh
      ?item.CanActivate()
        activate potion
    :?foe = yeti
      ?isInState(32, 1)
        activate potion
	:foe.state > 1
	  activate potion

  ?foe = nagaraja
  ^& foe.state > 1
    AssignLeft(getMainWeapon(), 2)
    AssignRight(getMainOffhandWeapon(), 2)
  :?icePillarWeapon
  ^& foe = ice wall
    AssignLeft(icePillarWeapon, 2.6)
    AssignRight("moondial", 2.6)
  :?stoneHammerA & stoneHammerB
  ^& foe = poena 
    AssignLeft(stoneHammerA, 3.4)
    AssignRight(stoneHammerB, 3.4)
  :?foe = bolesh
    Set("isDashBlocked", true)
    AssignBoth(getMainRanged(), 3.5)
  :?foe = pallas
  ^& foe = phase2
    AssignRight(lifeStealShield, 2)
  :?foe = yeti
  ^& (isInState(133, 0) ! isInState(143, 0))
    AssignBoth(getMainRanged(), 3.5)
  
  ?item.GetCooldown("mind") <= 0
  ^& (
  ^    foe = bronze_guardian & isInState(32, 10)
  ^  | foe = nagaraja & isInState(112, 53)
  ^  | foe = dysangelos & foe = phase1 & isInState(33, 0)
  ^  | foe = dysangelos & foe = phase3 & isInState(115, 60)
  ^  | foe = pallas & foe = phase1 & isInState(32, 60)
  ^)
    Dodge()

:? isCloseAs("ranged")
    
  ?devourFireRuneThreshold > 0
  ^& summon.GetId() = cinderwisp
  ^& summon.GetVar("ignition") >= devourFireRuneThreshold
  ^& isShortOfBestTimeBy(90)
    activate cinderwisp

  ?item.GetCount("skeleton") > 0 & isPickPocketingWithSkeletonArm & item.GetCooldown("skeleton_arm") <= 0
    AssignBoth("skeleton", 3.2)
    ?getBuffCount("pick_pocket") >= maxPickPocketBuffs
    ^& item.CanActivate()
    ^& foe.distance <= 7
    ^& (!isOnPPKillQuest | (foe.armor + foe.hp) <= 10 & foe.hp > 0)
      AssignBoth("skeleton")
      AssignActivate("skeleton")

  ?(foe = ice pillar | foe = ice wall) & isCloseAs("ranged") & icePillarWeapon
    AssignLeft(icePillarWeapon, 3)

  ?item.GetCooldown("mind") <= 0 
  ^& getEndurance() < 0.75
  ^& !isSpeedRunning
  ^& isCloseAs("close")
    Dodge()

  ?foe = acronian & loc = temple
    AssignLeft(getMainWeapon(), 2)
	?getMainOffhandWeapon()
      AssignRight(getMainOffhandWeapon(), 2)
    ?item.GetCooldown("mind") <= 0
    ^& armor < foe.damage
    ^& isInState(32, 6)
      Dodge()

  ?foe = bomb cart
    ?foe.distance < 7
      U.Dodge()
      equip mind
    :?U.isInRange(11, 15)
      equipR dash

?canDash()
  AssignRight(canDash(), 3.5)
  
?getEndurance() < 0.25
^& (
^  item.potion = healing
^| item.potion = defensive
^| item.potion = cleansing
^| item.potion = vampiric
^  )
  ?healthHammer
  ^& item.potion = defensive
    ?item.left ! healthHammer
      AssignLeft(healthHammer, 3.4)
    :?maxhp > 50
      activate potion
      AssignLeft("", -1, "")
  :
    activate potion

EquipItems()
ActivateItem()
